<% layout('layout') %>
    <head>
        <style>
            .mainf {
                position: relative;
            }
            .resetPassCard, .newAccCard {
                position: absolute;
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
                z-index: 50;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .resetCard, .newCard {
                width: 500px;
                height: 450px;
                background-color: white;
                border-radius: 14px;
                box-shadow: var(--shadow);
            }
            .main {
                display: block;
                gap: 0;
                padding: 0;
                flex-direction: column;
                width: 100%;
                height: auto !important;
                overflow-y: auto;
            }
            .maindocPage {
                display: block;
                height: 1056px;
                width: 816px;
                background-color: white;
                align-self: center !important;
            }
            .card.col.tray {
                box-shadow: none;
                overflow-y: auto;
                display: block;
                align-items: start;
                justify-content: start;
            }
            .block {
                padding: 0 20px;
                width: 100%;
                position: relative;
                background-color: var(--lightgray);
                border-radius: 15px;
            }
            .block.s {
                width: 15%;
                height: auto;
                flex-direction: column;
                justify-content: start;
            }
            .main .card {
                padding: 40px;
                align-items: start;
                gap: 4px;
            }
            .title {
                line-height: 2em;
            }
            .main p {
                line-height: 1.5em;
                display: flex;
                align-items: center;
                justify-content: center;

            }
            .main p i {
                width: 20px;
                font-size: 12px;
            }
            .card.keyPlain {
                height: 50%;
            }
            .card.Btn {
                position: relative;
                flex-direction: column;
                padding: 10px 20px;
                align-items: center;
                justify-content: center;
                height: auto;
                font-size: 14px;
                font-weight: 500;
                gap: 20px;
            }
            .tray p {
                text-align: left;
                justify-content: start;
            }
            #docButtonCard {
                height: 100%;
            }
            #docf {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }
            #docPage {
                padding: 50px 150px;
                border-radius: 0;
                background-color: transparent;
                justify-content: start;
                justify-items: start;
                height: 1050px;
            }
            .cmpCard {
                flex-direction: column;
                align-items: start;
                padding: 10px;
                height: auto;
            }
            .docHead {
                position: absolute;
                bottom: 0;
                right: 38px;
                z-index: 50;
                flex-direction: column-reverse;
                height: 100%;
                gap: 10px;
                width: 15%;
                align-items: center;
                justify-content: space-between;
                padding-block: 20px;
            }
            .docHead .ctrl {
                height: auto;
                padding: 0;
                width: 100%;
                flex-direction: column;
            }
            .docHead .ctrl.right {
                flex-direction: row;
            }
            .docHead .ctrl.left .nav {
                width: 100%
            }
            .docHR {
                opacity: 1;
                width: 90%;
                border: 2px solid black;
            }
            .pageMainf {
                padding-inline: 60px;
            }
            .sub {
                height: 30px;
            }
            .totalRecords {
                font-size: 18px;
                font-weight: 500;
            }
            .userPhoto {
                height: 100px;
                width: 100px;
                outline: 1px solid lightgray;
            }
            .userH {
                height: 50px;
                padding: 0;
            }
            form {
                width: 100%;
                padding: 20px 300px;
            }
            #dirTable {
                box-shadow: var(--dangerShadow);
            }
            .headCtrl {
                padding: 5px;
            }
            .headCtrl .ctrl {
                width: 97.5%;
                background-color: white;
                border-radius: 0.5vw;
            }
            .certContent {
                position: absolute;
                z-index: 50;
                left: 10px;
                bottom: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                height: auto;
                padding: 15px;
                width: 18%;
            }
            .certTA, .certTA:hover, .certTA:focus {
                height: calc(38 * 1em);
            }
            .certContentM {
                white-space: pre-wrap; /* Preserves new lines and spaces */
            }
            .hidden {
                display: none !important;
            }
            @media print {
                body {
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
                .maindocPage {
                    background-image: url('your-background-image.png') !important;
                    background-size: cover !important;
                }
                span {
                    font-size: 12pt !important;
                }
                sup, sub {
                    font-size: inherit !important;
                }
                p.docTLE {
                    font-size: 18pt !important;
                }.parag {
    text-indent: 30px;
    text-align: justify !important;
    display: inline !important;
    font-family: 'Times New Roman', Times, serif;
}
.paragStr {
    text-indent: 30px;
    text-align: justify !important;
    display: inline;
    font-family: 'Times New Roman', Times, serif;
    font-weight: bold;
    font-size: 1vw;
}
.txtStr {
    font-weight: bold !important;
}
.blue {
    color: rgb(1, 1, 111);
}
.certContent {
    height: calc(8 * 1em);
    width: 98%;
}
.certContentM {
    white-space: pre-wrap; /* Preserves new lines and spaces */
}
            }
            
.parag {
    text-indent: 30px;
    text-align: justify !important;
    display: inline !important;
    font-family: 'Times New Roman', Times, serif;
}
.paragStr {
    text-indent: 30px;
    text-align: justify !important;
    display: inline;
    font-family: 'Times New Roman', Times, serif;
    font-weight: bold;
    font-size: 1vw;
}
.txtStr {
    font-weight: bold !important;
}
.blue {
    color: rgb(1, 1, 111);
}

    #viewD {
        width: auto !important;
        max-width: none !important;
        min-width: none !important;
        justify-self: start;
        font-weight: 600;
        color: var(--primary);
    }
    #viewD:hover {
        transition: none;
        transform: scale(1);
    }

        </style>
    </head>
        <div class="hidden successCard padding10 fixed height0 borderRadius10 width0 darkShadow col" id="successCard" style="bottom: 30px; right: 30px; z-index: 100;">
                <p class="size14 str400"> <i class="fas fa-thumbs-up inline green"  style="transform: rotate(-8deg);"></i> The document has been approved successfully!</p>
        </div>
        <div class="hidden decCard padding10 fixed height0 borderRadius10 width0 darkShadow col black" id="decCard" style="bottom: 30px; right: 30px; z-index: 100;">
                <p class="size14 str400"> <i class="fas fa-thumbs-up inline black"  style="transform: rotate(-8deg);"></i> The document has been declined successfully!</p>
        </div>
        
        <div class="hidden claimedCard padding10 absolute height0 borderRadius10 width0 darkShadow col" id="claimedCard" style="bottom: 30px; left: 30px; z-index: 100;">
                <p class="size14 str400"> <i class="fas fa-thumbs-up inline green"  style="transform: rotate(-8deg);"></i> The request has been marked claimed successfully!</p>
        </div>
    
                <div class="absolute height0 width33 padding20 borderRadius10 bgWhite darkShadow col gap10" style="z-index: 10 !important; left: 12px; top: 10px;">
                    <div class="height0 justifyStart">                    
                        <a href="/srv" class="nav" onclick="">
                            <i class="fas fa-chevron-left"></i>
                            Previous
                        </a>
                    </div>
                    
                    <div class="h120 witch abstractBG padding20 borderRadius10 col alignStart justifyBetween relative">
                        <a href="" class="nav cnav disabled marginBottom15 absolute right10 bottom0" style="opacity: 0.1; transform: scale(2.8);"><i class="fas fa-receipt"></i></a>
                        <p class="size14 white str400">
                            <%= request.createdAt 
                                ? new Date(request.createdAt).toLocaleString("en-US", { 
                                    year: "numeric", 
                                    month: "short",  
                                    day: "2-digit", 
                                    hour: "2-digit", 
                                    minute: "2-digit", 
                                    hour12: true 
                                }).replace(/,\s(\d{4}),/, ', $1') 
                                : "Unreleased" 
                            %>
                        </p>
                        <p class="size26 str400 white">TR# <%= request.tr %></p>
                    </div>
                    


                    <div class="height0 justifyStart alignStart col padding5">
                        <img src="<%= request.resident.photo ? request.resident.photo : '/images/profile.jpg' %>" class="borderRadius10 h60 w60 borderPrimary marginBottom5" onerror="this.onerror=null; this.src='/images/profile.jpg';">
                        <p class="size16 str500"><%= request.resident.firstName %> <%= request.resident.middleName %> <%= request.resident.lastName %> <%= request.resident.extName %></p>
                        <p class="size16 str500"><%= request.resident.household ? request.resident.household.houseNo : "N/A" %> <%= request.resident.household ? request.resident.household.purok : "N/A" %> Valdefuente</p>
                        <p class="size16 str500">Poverty Status: <%= request.resident.family ? request.resident.family.poverty : "N/A" %></p>
                        <br>
                        <% if (request.cases.length > 0) { %>
                            <% request.cases.forEach(caseItem => { %>
                                <% 
                                    const isRespondent = caseItem.respondents.some(r => r._id && r._id.equals(request.resident._id));
                                %>
                                <% if (isRespondent) { %>
                                    <p class="size16 str500" style="color: rgb(126, 0, 0);">
                                        <i class="fas fa-exclamation-circle inline width15"></i> Pending Case Found : &nbsp;
                                        <a id="viewD" class="inline">Show Details</a>
                                    </p>
                                <% } else { %>
                                    <p class="size16 str500">
                                    <i class="fas fa-check-circle marginInline5"></i>
                                    No case records found!
                                    </p>

                                <% } %>
                            <% }) %>
                        <% } else { %>
                            <p class="size16 str500">
                                <i class="fas fa-check-circle w15 inline"></i>
                                No case records found!
                            </p>
                        <% } %>

                            <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    // Get references to the buttons and the div
                                    const viewButton = document.getElementById('viewD');
                                    const closeButton = document.getElementById('close7'); // Get the close button
                                    const caseCard = document.getElementById('caseCard7');

                                    // --- Functionality for the "View Details" button ---
                                    if (viewButton && caseCard) { 
                                        viewButton.addEventListener('click', function() {
                                            // Remove the 'hidden' class from the div to make it visible
                                            caseCard.classList.remove('hidden');

                                            // Optional: Hide the "View Details" button after clicking it
                                            // if you only want to show it once the card is open.
                                            viewButton.style.display = 'none'; 
                                        });
                                    }

                                    // --- Functionality for the "Close" button ---
                                    if (closeButton && caseCard) { // Check if elements exist
                                        closeButton.addEventListener('click', function() {
                                            // Add the 'hidden' class back to the div to hide it
                                            caseCard.classList.add('hidden');

                                            // Optional: Show the "View Details" button again
                                            // if you hid it when the card was opened.
                                            if (viewButton) { // Ensure viewButton exists before trying to show it
                                                viewButton.style.display = 'inline'; // Or 'inline-block' or '' depending on original display type
                                            }
                                        });
                                    }
                                });
                            </script>
                            
                            <script>
                                function formatDate(dateString) {
                                    if (!dateString) return "Unreleased"; // If no date, return "Unreleased"
                                    const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
                                    return new Date(dateString).toLocaleDateString('en-US', options);
                                }
                            
                                let successAtElement = document.getElementById("successAt");
                                let successAtRaw = successAtElement.getAttribute("data-date");
                            
                                if (successAtRaw) {
                                    successAtElement.textContent = formatDate(successAtRaw);
                                }
                            </script>
                    </div>

                    <div class="height0 alignStart padding5 col">
                        <p class="size16 str500">Status: <%= request.status %></p>
                        <p class="size16 str500">
                            <%= request.successAt 
                                ? new Date(request.successAt).toLocaleString("en-US", { 
                                    year: "numeric", 
                                    month: "short",  
                                    day: "2-digit", 
                                    hour: "2-digit", 
                                    minute: "2-digit", 
                                    hour12: true 
                                }).replace(/,\s(\d{4}),/, ', $1') 
                                : "Unreleased" 
                            %>
                        </p>
                    </div>

                    <div class="height0 gap10">
                            <% if ( request.status === 'For Pickup') { %>
                            <p class="size14 str400">Has the document been released?</p>
                                <a href="#" class="nav" onclick="showNoCard2('<%= request._id %>')">
                                <i class="fas fa-check"></i> Set as Claimed
                                </a>
                            <% } %>
                    </div>


                </div>
    <div class="blockX overflow-y1 relative">

        <div id="caseCard7" class="hidden height100 absolute top0 left0 index50 overflow-y1 alignStart padding30">
            <div class="width60 darkShadow height0 heightMin100 bgWhite padding20 borderRadius15 relative col justifyStart">
                <a href="javascript:void()" class="nav absolute top20 right20" id="close7"><i class="fas fa-xmark"></i> Close</a>
                
                <p class="size28 str500"><i class="fas fa-exclamation-triangle red inline" style="font-size: 26px;"></i> Pending Case Record</p>
                <br>
                    <% if (request.cases.length > 0) { %>

                                <% request.cases.forEach(caseItem => { %>
                                    <div class="card width80 height0 padding20 col relative alignStart justifyCenter borderPrimary marginBottom10">
                                        <a href="" class="nav tnav absolute right15 top15 disabled hidden">Status: <%= caseItem.status %></a>
                                        <p class="size12 absolute right20 top20 disabled">
                                            <%= caseItem.createdAt 
                                                ? new Date(caseItem.createdAt).toLocaleString("en-US", { 
                                                    year: "numeric", 
                                                    month: "short",  
                                                    day: "2-digit", 
                                                    hour: "2-digit", 
                                                    minute: "2-digit", 
                                                    hour12: true 
                                                }).replace(/,\s(\d{4}),/, ', $1') 
                                                : "?" 
                                            %></p>
                                        <p class="size16 str500 green">Case No. <%= caseItem.caseNo %></p>
                                        <p class="size16 str600"><%= caseItem.type.join(", ") %></p>
                                        <br>
                                     
                                        <p class="size12 str400">Complainant(s)</p>
                                        <p class="size14 str600"><% caseItem.complainants.forEach(c => { %>
                                                <%= c.firstName %> <%= c.middleName %> <%= c.lastName %> <%= c.extName || '' %><br>
                                            <% }) %>
                                        </p>
                                        <br>
                                        <p class="size12 str400">Respondent(s)</p>
                                        <p class="size14 str600 "><% caseItem.respondents.forEach(r => { %>
                                                <%= r.firstName %> <%= r.middleName %> <%= r.lastName %> <%= r.extName || '' %><br>
                                            <% }) %>
                                        </p>
                                        <br>
                                        <a href="/caseView/<%= caseItem._id %>" class="btn btn-primary nav hidden">View Case</a>
                                    </div>
                                <% }) %>
                    <% } else { %>
                        <p>No case records found.</p>
                    <% } %>
                </div>
        </div>

        <div class="borderRadius15 padding20 absolute index100 hidden" style="background-color: rgba(0, 0, 0, 0.5);" id="noCard">
            <form class="flex height0 bgWhite padding40 borderRadius10 width40 darkShadow col">
                <p class="size30 str500">DECLINE DOCUMENT?</p>
                <br>
                <label for="" class="width100 textLeft hidden">Reason for declining</label>
                <div class="height0 hidden">
                    <div class="selectBar width100 widthMax100">
                        <select name="notes" id="notesInput" required>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                </div>
                <br>
                <div class="height0 padding20 borderRadius10 borderPrimary">
                    Note: Action can't be undone!
                </div>
                <br>
                <div class="height0 gap10">
                    <button class="nav fnav" onclick="hideNoCard()">Cancel</a>
                    <button type="submit" class="nav fnav gnav"  onclick="declineDocument()">Decline</button>
                </div>
            </form>
        </div>

        <div class="borderRadius15 padding20 absolute index100 hidden" 
            style="background-color: rgba(0, 0, 0, 0.5);" 
            id="noCard2">
        <form class="flex height0 bgWhite padding40 borderRadius10 width40 darkShadow col" 
                onsubmit="return false;">
            <p class="size30 str500">Are you sure this request has been released?</p>
            <br>
            <div class="height0 padding20 borderRadius10 borderPrimary">
            Note: This action can't be undone!
            </div>
            <br>
            <div class="height0 gap10">
            <button type="button" class="nav fnav" onclick="hideNoCard2()">Cancel</button>
            <button type="button" class="nav fnav gnav" id="confirmReleaseBtn">Set as Claimed</button>
            </div>
        </form>
        </div>
        
        <div class="height0 col padding10 mdoc" id="mdoc">
            <% if (typeof message !== "undefined" && message) { %>
                <div class="alert alert-success height0 absolute right30 top30">
                    <%= message %>
                </div>
            <% } %>

        
            

            <div class="card col height0 shadowNone" style="padding: 5px 5px 5px 35%;">


                    <div class="height0 padding15 col borderRadius10 darkShadow">
                        <div class="height0 padding20 aqua abstractBG borderRadius10 white justifyBetween">
                        <a href="" class="nav cnav disabled marginBottom15 absolute right10 bottom0" style="opacity: 0.1; transform: scale(2.8); z-index: 0;"><i class="fas fa-file-alt"></i></a>
                            <p class="size24 str400">Requested Document</p>
                            <div class="height0 gap10 width0 justifyEnd index50">
                                <% if ( request.status === 'Processing' || request.status !== 'Approved' &&  request.status !== 'Declined' && request.status !== 'For Pickup' && request.status !== 'Claimed' ) { %>
                                <% } %>

                                <% if ( request.status !== 'Declined' && request.status !== 'Pending' && request.status !== 'Processing' ) { %>
                                <a href="#" class="nav" onclick="viewDocs()">
                                    <i class="fas fa-eye"></i>
                                    View Documents
                                </a>
                                <a href="#" class="nav" onclick="printDocs()">
                                    <i class="fas fa-print"></i>
                                    Print Documents
                                </a>
                                <% } %>
                            </div>
                        </div>
                        <br>
                            <div class="height0 gap20 borderRadius20 wrap alignStart padding5">
                                <% if (request.documents.length > 0) { %>
                                    <% request.documents.forEach(doc => { %>
                                        <div id="doc-<%= doc._id %>" class="
                                            <% if ( doc.status === 'Approved') { %>
                                            bgWhite softShadow
                                            <% } else if  ( doc.status === 'Declined') { %>
                                            borderGray bgSoft
                                            <% } else { %>
                                            bgWhite softShadow
                                            <% } %>
                                            borderRadius10 padding20 col relative justifyBetween h160 alignStart" style="min-width: 48%; flex: 1 1 48%;">
                                            <a href="#" class="nav cnav disabled absolute right10 top10 hidden"><i class="fas fa-file"></i></a>
                                            <div class="height0 col justifyStart alignStart marginTop40">
                                                <p class="size14 str400"><%= doc.qty == 1 ? doc.qty + " Copy" : doc.qty + " Copies" %> for</p>
                                                <p class="size14 str500 colorPrimary"><%= doc.purpose %> Purpose</p>
                                            </div>
                                                
                                            <div class="height0 padding0 gap10 absolute top15 left0 justifyStart width100">
                                                <% if (doc.status === 'Approved') { %>
                                                    <p class="size14 str500 abstractBG paddingInline15 paddingBlock10 alignStart flex gap10 white" style="border-top-right-radius: 20px;">
                                                        <i class="fas fa-check-square size18"></i> Approved
                                                    </p>
                                                <% } else if  (doc.status === 'Declined') { %>
                                                    <p class="size14 str500 bgGray abstractBG paddingInline15 paddingBlock10 alignStart flex gap10 white" style="border-top-right-radius: 20px;">
                                                        <i class="fas fa-check-square size18"></i> Declined
                                                    </p>
                                                <% } else { %>
                                                    <p class="size14 str500 bgGray abstractBG paddingInline15 paddingBlock10 alignStart flex gap10 white" style="border-top-right-radius: 20px;">
                                                        <i class="fas fa-hourglass size18"></i> Pending
                                                    </p>
                                                <% } %>
                                                <p class="size16 str500"><%= doc.type %></p>
                                            </div>                                               
                                            <% if (doc.status === 'Pending' && request.status !== 'Cancelled') { %>  
                                            <div class="height0 justifyEnd gap10 padding5">
                                                    <a href="javascript:void(0)" onclick="showNoCard('<%= doc._id %>')" class="nav fnav dnav w150">
                                                        Decline
                                                    </a>                          
                                                    <a href="javascript:void(0)" class="nav fnav pnav borderPrimary str400 w150" onclick="approveDocument('<%= doc._id %>')">
                                                        Approve
                                                    </a>
                                            </div>
                                            <% } %>
                                            <% 
                                            const updatedAt = new Date(request.updatedAt);
                                            const elapsed = Date.now() - updatedAt.getTime();
                                            %>

                                            <% if ((doc.status === 'Approved' || doc.status === 'Declined') && elapsed < 30000) { %>
                                            <div
                                                class="height0 justifyEnd gap10 padding5 revert-btn hidden"
                                                data-updated-at="<%= updatedAt.toISOString() %>">
                                                <a href="javascript:void(0)" class="nav fnav borderPrimary str500 width0"
                                                onclick="restoreDocument('<%= doc._id %>')">
                                                <i class="fas fa-arrows-rotate"></i> Revert Action
                                                </a>
                                            </div>
                                            <% } %>
                                        </div>
                                    <% }); %>
                                 <% } else { %>
                                    Missing Document in request
                                <% } %>
                            </div>
                            </div>
            </div>
        </div>

        <div class="height0 col relative hidden vdoc bgSoft borderRadius10" id="vdoc" style="padding-left: 35%;">
            <a href="" class="nav fixed top40 index50 marginRight35" id="xBtn" style="left: 40%;"><i class="fas fa-times"></i>Close View</a>
            <% 
            function calculateAge(bDay, bMonth, bYear) {
                const birthDate = new Date(bYear, bMonth - 1, bDay);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            } 
            %>
            <% const approvedDocs = request.documents.filter(doc => doc.status === "Approved"); %>
            <% if (approvedDocs.length > 0) { %>
                <% approvedDocs.forEach(doc => { %>
                    <% for (let i = 0; i < doc.qty; i++) { %>
    
            <div class="height0 justifyEnd borderRadius10 doc" id="doc<%= i+1 %>" style="padding: 10px;">
                <p class="status hidden"><%= doc.status %></p>
                <p class="qty hidden"><%= doc.qty %></p>
                <div class="maindocPage darkShadow  borderRadius5" id="clearance" style="position: relative;">
                    <br>
                    <img src="/images/logo.png" alt="" style="height: 800px; position: absolute; opacity: 0.1; z-index: 0;transform: translate(-50%, -50%); left: 50%; top: 55%;">
                    <br>
                    <div class="section letterhead">
                        <div class="ctrl" style="width: 200px; height: 150px; justify-content: end;">
                            <img src="/images/logo.png" alt="">
                        </div>
                        <div class="ctrl col" style="flex: 1; gap: 0;">
                            <p class="p14 oldEnglish">Republic of the Philippines</p>
                            <p class="p10 tnr" style="text-align: center;">City of Cabanatuan<br>BARANGAY VALDEFUENTE</p>
                            <p class="p16 impact">&nbsp;TANGGAPAN NG PUNONG BARANGAY&nbsp;</p>
                        </div>
                        <div class="ctrl" style="width: 200px; height: 150px; justify-content: start;">
                            <img src="/images/cablogo.png" alt="">
                        </div>
                    </div>
                    <center><hr class="docHR"></center>
                    <div class="section" style="gap: 0; padding: 0; align-items: start;">
                        <div class="section smallWidth pageSidef col" style="gap: 0;">
                            <br>
                            <p class="p10 tnr officialName">FRANCISCO s. VELASQUEZ</p>
                            <p class="p10 tnr officialName">Punong Barangay</p>
                            <br><br>
                            <p class="p10 tnr officialName">KAGAWAD:</p>
                            <br><br>
                            <p class="p10 tnr officialName">CARMELITA M. ANGELES</p>
                            <br><br>
                            <p class="p10 tnr officialName">JOEY P. SAMSON</p>
                            <br><br>
                            <p class="p10 tnr officialName">NOEMI N. ABULENCIA</p>
                            <br><br>
                            <p class="p10 tnr officialName">CEAZAR T. CRUZ</p>
                            <br><br>
                            <p class="p10 tnr officialName">TERESITA M. SANTIAGO</p>
                            <br><br>
                            <p class="p10 tnr officialName">ALEXANDER I. MATEO</p>
                            <br><br>
                            <p class="p10 tnr officialName">VOLTAIRE B. GEMPESAW</p>
                            <br><br><br>
                            <p class="p10 tnr officialName">ARNOLD A. APAN</p>
                            <p class="p10 tnr officialName">Barangay Secretary</p>
                            <br><br>
                            <p class="p10 tnr officialName">DIOSA P. PASCUAL</p>
                            <p class="p10 tnr officialName">Barangay Treasurer</p>
                            <br><br>
                            <br><br>
                            <br><br>
                            <br><br>
                            <br><br>
                            <br><br>
                        </div>
                        <div class="section largeWidth pageMainf">
                            <br>
                            <% if ( doc.type === 'Barangay Clearance' || doc.type === 'Barangay Indigency' || doc.type === 'Good Moral' || doc.type === 'Certificate of Residency' ) { %>
                            <p class="p18 str600 tnr docTLE" style="text-align: center; justify-content: center; align-items: center; width: 100%; color: red;">
                                <% if (doc.type === 'Barangay Clearance') { %>
                                    BARANGAY CLEARANCE
                                <% } else if (doc.type === 'Barangay Indigency') { %>
                                    CERTIFICATE OF INDIGENCY
                                <% } else if (doc.type === 'Certificate of Residency') { %>
                                    CERTIFICATE OF   RESIDENCY
                                <% } else if (doc.type === 'Good Moral') { %>
                                    GOOD MORAL CERTIFICATE
                                <% } %>                            
                            </p>
                            <br>
                            <p class="p10 tnr">TO WHOM IT MAY CONCERN:</p>
                            <br>
                            <p class="p10 parag" style="display: inline;">
                                THIS IS TO CERTIFY that 
                                <span class="paragStr"><%= request.resident.firstName %> <%= request.resident.middleName %> <%= request.resident.lastName %> <%= request.resident.extName %></span>,
                                <span class="paragStr"><%= request.resident.civilStatus %></span>, is a bonafide resident of this barangay with permanent address at 
                                <span class="paragStr">
                                    <%= request.resident.household ? request.resident.household.houseNo : "N/A" %> <%= request.resident.household ? request.resident.household.purok : "N/A" %>, Valdefuente, Cabanatuan City
                                </span>.
                            </p>
                            <br>
                            <% if ( doc.type === 'Barangay Clearance') { %>
                            <p class="p10 parag">
                                That the above-mentioned has <span class="paragStr blue">
                                    <% if (request.cases.length > 0) { %>
                                        
                                    <% } else { %>
                                        
                                    <% } %>

                                    
                                        <% if (request.cases.length > 0) { %>
                                            <% request.cases.forEach(caseItem => { %>
                                                <% 
                                                    const isRespondent = caseItem.respondents.some(r => r._id && r._id.equals(request.resident._id));
                                                %>
                                                <% if (isRespondent) { %>
                                                    PENDING CASE
                                                <% } else { %>
                                                    NO DEROGATORY RECORD
                                                <% } %>
                                            <% }) %>
                                        <% } else { %>
                                            NO DEROGATORY RECORD
                                        <% } %>
                                    
                                </span> on file in this office as of this date.
                            </p>
                            <% } %>
                            <% if ( doc.type === 'Barangay Indigency') { %>
                                <p class="p10 parag">THIS IS TO CERTIFY ALSO that the name mentioned above is a member of an <span class="paragStr blue">INDIGENT FAMILY</span> of this barangay.</p>
                            <% } %>
                            <% if ( doc.type === 'Good Moral') { %>
                                <p class="p10 parag" style="display: inline;">That the above mentioned has known to me as a good person with a <span class="paragStr">GOOD MORAL CHARACTER and NO DEROGATORY RECORD</span> on file in this office as of this date. </p>
                            <% } %>
                            <br>
                            <p class="p10 parag">
                                This was issued upon request of the subject for <span class="paragStr blue" id="purposeRef"><%= doc.purpose %></span> Reference Purpose only.
                            </p>
                            <br>
                            <p class="p10 parag">
                                Given this <span class="paragStr thisDay" id=""></span> day of 
                                <span class="paragStr thisMonth" id=""></span>, 
                                <span class="paragStr thisYear" id=""></span> at Barangay Valdefuente, Cabanatuan City.
                            </p>
                            <br>
                            <% } %>
    
                            <% if ( doc.type === 'Certification') { %>
                            <p class="p18 str600 tnr docTLE" style="text-align: center; justify-content: center; align-items: center; width: 100%; color: red;">
                                PAGPAPATUNAY
                            </p>
                            <br>
                            <p class="p10 tnr">PARA SA KINAUUKULAN:</p>
                                <br>
                                <p class="p10 parag" style="display: inline;">Ito ang pagpapatunay na si <span class="paragStr"><%= request.resident.firstName %> <%= request.resident.middleName %> <%= request.resident.lastName %> <%= request.resident.extName %></span>, ay lehitimong mamamayan ng aming Barangay na kasalukuyang nakatira sa <span class="paragStr"><%= request.resident.houseNo %> <%= request.resident.purok %>, Valdefuente, Cabanatuan City</span>.</p>
                                <br>
                                <p class="p10 parag certContentM" id="certContentM"></p>
                                <script>
                                    document.getElementById('certContent').addEventListener('input', function() {
                                        document.getElementById('certContentM').textContent = this.value; 
                                    });
                                    
                                    </script>
                                <br>
                                <p class="p10 parag">Ang pagapatunay na ito ay ginawa sa kahilingan ng nabanggit para sa anumang pangangailangan.
                                <br>
                                <p class="p10 parag">Ginawa ngayong ika-<span class="paragStr thisDay2" id=""></span> ng <span class="paragStr thisMonth2" id=""></span>, taong <span class="paragStr thisYear" id=""></span>.</p>
                            <br>
                            <% } %>
    
                            <div class="height0 col alignEnd">
                                <p class="size14 txtStr tnr width60" style="display: flex; justify-content: left;">PREPARED BY:</p>
                                <br><br>
                                <p class="size14 txtStr tnr width60" style="display: flex; justify-content: center;">ARNOLD A. APAN</p>
                                <p class="size14 tnr width60" style="display: flex; justify-content: center;">Barangay Secretary</p>
                            </div>
                            <div class="height0 col alignStart">
                                <p class="size14 txtStr tnr width60" style="display: flex; justify-content: left;">APPROVED BY:</p>
                                <br><br>
                                <p class="size14 txtStr tnr width60 blue" style="display: flex; justify-content: center;">FRANCISCO S. VELASQUEZ</p>
                                <p class="size14 tnr width60" style="display: flex; justify-content: center;">Punong Barangay</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>
            <br>
            <% }); %>
         <% } else { %>
            
        <% } %>
    
            
    
        </div>
    </div>
  
  


            <script>
                function printDocs() {
                    const docElements = document.querySelectorAll(".maindocPage");
            
                    if (docElements.length === 0) {
                        alert("Error: Documents not found!");
                        return;
                    }
            
                    // Create a new print window
                    const printWindow = window.open("", "_blank");
                    printWindow.document.open();
            
                    // Copy all styles from the main document
                    let styles = "";
                    document.querySelectorAll("link[rel='stylesheet'], style").forEach((style) => {
                        styles += style.outerHTML;
                    });
            
                    // Write the new document with styles
                    let content = "";
                    docElements.forEach((element) => {
                        content += `<div class="maindocPage">${element.outerHTML}</div>`;
                    });
            
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Print Documents</title>
                            ${styles} <!-- Include copied styles -->            
            <style>@media print {
    /* Ensures background colors and images are printed */
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;

    /* Ensure images print with full opacity */
    img {
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
    }

    /* Fixes absolute-positioned watermark images */
    .watermarkImage {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 100% !important;
        height: auto !important;
        opacity: 0.2 !important;
        z-index: -1 !important;
    }

    /* Ensures textareas display input */
    textarea {
        border: none;
        width: 100%;
        height: auto;
        resize: none;
        overflow: visible;
        white-space: pre-wrap; /* Ensures text wraps properly */
        background: transparent !important;
    }
}

                @media print {
                    @page {
                        size: A4 portrait;
                        margin: 0;
                    }
                    body {
                        margin: 0;
                        padding: 0;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: flex-start;
                        width: 100%;
                        height: auto;
                        box-sizing: border-box;
                        background: white;
                        color: black;
                    }
                    .maindocPage {
                        width: 100%;
                        max-width: 100%;
                        font-size: 12pt !important;
                        line-height: 1.2;
                        height: 297mm; /* A4 height */
                        display: block;
                        page-break-before: always;
                        page-break-inside: avoid;
                    }
                    textarea {
                        border: none;
                        width: 100%;
                        height: auto;
                        resize: none;
                        overflow: visible;
                        white-space: pre-wrap; /* Ensures text wraps properly */
                    }
                    h1, h2, h3 {
                        font-size: 16pt !important;
                    }
                    p {
                        font-size: 12pt !important;
                    }
                    .docTLE {
                        font-size: 18px !important;
                    }
                    .page-break {
                        page-break-before: always;
                        display: block;
                        height: 1px;
                        width: 100%;
                    }
                }
            </style>
                        </head>
                        <body onload="setTimeout(() => { window.print(); window.close(); }, 500)">
                            ${content}
                        </body>
                        </html>
                    `);
            
                    printWindow.document.close();
                    printWindow.focus();
                }
            </script>
            
       

            
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the current date
        const currentDate = new Date();
    
        // Get the current year, month (0-based, so +1 for the correct month), and day
        const currentYear = currentDate.getFullYear();
        const currentMonthIndex = currentDate.getMonth();  // Months are 0-indexed (0 = January, 11 = December)
        const currentDay = currentDate.getDate();
    
        // Array of month names in English
        const monthNames = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ];
    
        // Array of month names in Tagalog
        const monthNamesTagalog = [
            "Enero", "Pebrero", "Marso", "Abril", "Mayo", "Hunyo", 
            "Hulyo", "Agosto", "Setyembre", "Oktubre", "Nobyembre", "Disyembre"
        ];
    
        // Get the current month name in English and Tagalog
        const currentMonth = monthNames[currentMonthIndex];
        const currentMonthTagalog = monthNamesTagalog[currentMonthIndex];
    
        // Function to get the ordinal suffix for the day
        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return day + "th";  // Handle 11th to 13th
            switch (day % 10) {
                case 1: return day + "st";
                case 2: return day + "nd";
                case 3: return day + "rd";
                default: return day + "th";
            }
        }
    
        // Get the ordinal form of the day
        const ordinalDay = getOrdinalSuffix(currentDay);
    
        // Update elements with the classes
        document.querySelectorAll('.thisYear').forEach(el => el.textContent = currentYear);
        document.querySelectorAll('.thisMonth').forEach(el => el.textContent = currentMonth);
        document.querySelectorAll('.thisDay').forEach(el => el.textContent = ordinalDay);
        
        // Update elements with new requirements
        document.querySelectorAll('.thisDay2').forEach(el => el.textContent = currentDay); // Only number
        document.querySelectorAll('.thisMonth2').forEach(el => el.textContent = currentMonthTagalog); // Tagalog month name
    });
    </script>


<script>
document.getElementById('certContent').addEventListener('input', function() {
    document.getElementById('certContentM').textContent = this.value; 
});

</script>
<script>
    const openResetCard = document.getElementById('openResetCard');
    const resetPassCard = document.getElementById('resetPassCard');
    const closeResetCard = document.getElementById('closeResetCard');

    openResetCard.addEventListener('click', function(e) {
        e.preventDefault();
        resetPassCard.style.display = 'flex';
    });

    closeResetCard.addEventListener('click', function(e) {
        e.preventDefault();
        resetPassCard.style.display = 'none';
    });
</script>

<script>
let selectedDocId = null;

function showNoCard(docId) {
    selectedDocId = docId;
    document.getElementById("noCard").classList.remove("hidden");
}

function hideNoCard() {
    selectedDocId = null;
    document.getElementById("noCard").classList.add("hidden");
}

async function declineDocument() {
    if (!selectedDocId) return;

    const notesInput = document.getElementById("notesInput"); 
    if (!notesInput) {
        alert("Notes input field not found.");
        return;
    }

    const notes = notesInput.value.trim();
    if (!notes) { 
        alert("Please enter a reason for declining."); 
        notesInput.focus(); 
        return;
    }

    const decCard = document.querySelector(".decCard"); // success card for decline
    const noCard = document.getElementById("noCard");    // the decline form/card

    // Show decline card immediately (optimistic UI)
    if (decCard) decCard.classList.remove("hidden");

    try {
        const response = await fetch(`/noDoc/${selectedDocId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ notes })
        });

        const result = await response.json();

        if (result.success) {
            // Keep it visible briefly, then reload
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            console.error("Decline failed:", result.message);
            alert("Failed to decline the document. Please try again.");
            if (decCard) decCard.classList.add("hidden"); 
        }
    } catch (error) {
        console.error("Error:", error);
        alert("An error occurred while processing your request.");
        if (decCard) decCard.classList.add("hidden"); 
    } finally {
        if (noCard) noCard.classList.add("hidden"); // hide decline form
    }
}

async function approveDocument(docId) {
    const successCard = document.querySelector(".successCard");

    // Show success card right away
    if (successCard) successCard.classList.remove("hidden");

    try {
        const response = await fetch(`/yesDoc/${docId}`, { method: "POST" });

        if (!response.ok) throw new Error("Failed to approve document");

        setTimeout(() => {
            location.reload();
        }, 2000);

    } catch (error) {
        console.error("Error:", error);
        if (successCard) successCard.classList.add("hidden");
        alert("An error occurred while approving the document.");
    }
}
</script>


<script>
  let currentRequestId = null;

  function showNoCard2(requestId) {
    currentRequestId = requestId; // store request ID
    document.getElementById("noCard2").classList.remove("hidden");
  }

  function hideNoCard2() {
    document.getElementById("noCard2").classList.add("hidden");
    currentRequestId = null;
  }

  async function releaseRequest() {
    if (!currentRequestId) return;

    try {
      const response = await fetch(`/release/${currentRequestId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const result = await response.json();

      if (result.success) {
        const claimedCard = document.getElementById("claimedCard");
        claimedCard.classList.remove("hidden");

        //  auto-close after 3 seconds
        setTimeout(() => {
          claimedCard.classList.add("hidden");
          location.reload(); // optional: reload page after closing
        }, 1000);
      } else {
        alert("Failed: " + (result.message || "Unknown error"));
      }
    } catch (err) {
      console.error("Error releasing request:", err);
      alert("An error occurred while updating.");
    } finally {
      hideNoCard2(); // hide confirmation modal anyway
    }
  }

  document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("confirmReleaseBtn");
    if (btn) btn.addEventListener("click", releaseRequest);
  });
</script>

<script>
    function viewDocs() {
    document.getElementById('vdoc').classList.remove('hidden');
    document.getElementById('mdoc').classList.add('hidden');
}

document.getElementById('xBtn').addEventListener('click', function () {
    document.getElementById('vdoc').classList.add('hidden');
    document.getElementById('mdoc').classList.remove('hidden');
});

</script>