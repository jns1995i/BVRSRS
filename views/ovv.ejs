<% layout('layout') %><% layout('layout') %>




<div class="height0">
    <div class="ctrl left">
        <p class="title">DOCUMENT SERVICES</p>
    </div>
    <div class="ctrl right">
        <a href="" class="nav hidden">
            <i class="fa-solid fa-download"></i>
            Export Report
        </a>
    </div>
</div>

<div class="height0">
    <div class="ctrl left">
        <div class="selectBar hidden">
            <select name="" id="">
                <option value="">Filter by Purok</option>
                <option value="">Dike Street</option>
                <option value="">Cantarilla</option>
                <option value="">Bagong Daan</option>
                <option value="">Shortcut</option>
                <option value="">Highway</option>
                <option value="">Perigola</option>
            </select>
        </div>
    </div>
    <div class="ctrl">
        <p class="title">Overall Request</p>
    </div>
    <div class="ctrl right">
        <div class="searchBar">
            <input type="search" id="univ">
            <i class="fas fa-search"></i>
        </div>
    </div>
</div>

<div class="main bgSoft borderRadius10 height70">


    <div class="section tableCard">
        <p class="p14" id="noRecords" style="display: none;">No Records</p>
        <table id="dirTable">
            <thead>
                <tr>
                    <th onclick="sortTable(4)" style="width: 15%;">Requested At</th>
                    <th onclick="sortTable(1)" style="width: 20%;">Requested By</th>
                    <th onclick="sortTable(2)" style="width: 35%;">Requested Documents</th>
                    <th onclick="sortTable(3)" style="width: 10%;">Status</th>
                    <th onclick="sortTable(5)" class="thCtrl">Action</th>
                </tr>
            </thead>
            <tbody>
                <% if (requests && requests.length > 0) { %>
                    <% requests.forEach(request => { %>
                        <tr>
                            <td>
                                <%= new Date(request.createdAt).toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: '2-digit' 
                                }) + ' • ' + new Date(request.createdAt).toLocaleTimeString('en-US', { 
                                    hour: 'numeric', 
                                    minute: '2-digit', 
                                    hour12: true 
                                }) %>
                            </td> 
                            <td>
                                <div class="height0 width0 justifyStart gap5">
                                    <img src="<%= request.resident && request.resident.photo ? request.resident.photo : '/images/profile.jpg' %>" 
                                         alt="" class="h25 w25 borderRadius500 borderPrimary">
                                    <%= request.resident 
                                        ? request.resident.firstName + ' ' + 
                                          (request.resident.middleName ? request.resident.middleName + ' ' : '') + 
                                          request.resident.lastName + ' ' + 
                                          (request.resident.extName ? request.resident.extName : '') 
                                        : 'Unknown' 
                                    %>
                                </div>
                            </td>
                            <td>
                                <% if (request.documents && request.documents.length > 0) { %>
                                    <% 
                                        let docSummary = {}; 
                            
                                        request.documents.forEach(doc => {
                                            let key = `${doc.type} for ${doc.purpose}`; // Merging type and purpose
                                            if (docSummary[key]) {
                                                docSummary[key] += doc.qty;
                                            } else {
                                                docSummary[key] = doc.qty;
                                            }
                                        });
                            
                                        Object.entries(docSummary).forEach(([docType, qty]) => { 
                                    %>
                                        <p><%= qty %> <%= qty > 1 ? 'copies' : 'copy' %> of <%= docType %></p>
                                    <% }); %>
                                <% } else { %>
                                    <p>No documents requested</p>
                                <% } %>
                            </td>                            
                            <td><%= request.status %></td>
                            <td class="tdCtrl alignCenter justifyCenter">
                                <a href="/srvView/<%= request._id %>" class="nav"><i class="fas fa-eye"></i> &nbsp; Details</a>
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="5">No requests found.</td>
                    </tr>
                <% } %>
                
            </tbody>
        </table>

    
</div>

<script>
function enforceNumericInput(event) {
    event.target.value = event.target.value.replace(/[^0-9]/g, '').slice(0, 11);
}

document.addEventListener('DOMContentLoaded', () => {
    const phoneInputs = document.querySelectorAll('.phone');
    phoneInputs.forEach(input => {
        input.addEventListener('input', enforceNumericInput);
    });
});
</script>

<script>document.addEventListener("DOMContentLoaded", function() {
const dirTable = document.getElementById("dirTable");
const tableBody = dirTable.getElementsByTagName("tbody")[0];
const paginationContainer = document.getElementById("pagination");
const rowsPerPageSelect = document.getElementById("rowsPerPage");
const totalRecordsLabel = document.getElementById("totalRecords");
const searchInput = document.getElementById("univ");
const noRecordsMessage = document.getElementById("noRecords");
const subDiv = document.querySelector(".sub");

let currentPage = 1;
let rowsPerPage = parseInt(rowsPerPageSelect.value);
let allRows = Array.from(tableBody.rows);
let filteredRows = allRows;

function renderTable() {
const start = (currentPage - 1) * rowsPerPage;
const end = start + rowsPerPage;

if (filteredRows.length === 0) {
    dirTable.style.display = "none";
    noRecordsMessage.style.display = "block";
} else {
    dirTable.style.display = "table";
    noRecordsMessage.style.display = "none";
}

if (filteredRows.length <= 5) {
    subDiv.style.display = "none";
} else {
    subDiv.style.display = "flex";
}

allRows.forEach(row => (row.style.display = "none"));
filteredRows.slice(start, end).forEach(row => (row.style.display = ""));

totalRecordsLabel.innerText = `Total Records: ${filteredRows.length}`;
renderPagination(filteredRows.length);
}
 
function renderPagination(totalRows) {
    paginationContainer.innerHTML = "";

    if (searchInput.value.trim()) return;

    const totalPages = Math.ceil(totalRows / rowsPerPage);
    if (totalPages <= 1) return;

    // Previous Button
    const prevButton = document.createElement("button");
    prevButton.innerHTML = "« Previous";
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        currentPage--;
        renderTable();
        renderPagination(totalRows); // Re-render pagination after page change
    };
    paginationContainer.appendChild(prevButton);

    // --- New Logic for displaying a limited number of page buttons ---

    // Display all buttons if total pages are 7 or less
    if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement("button");
            pageButton.innerHTML = i;
            pageButton.className = i === currentPage ? "active" : "";
            pageButton.onclick = () => {
                currentPage = i;
                renderTable();
                renderPagination(totalRows);
            };
            paginationContainer.appendChild(pageButton);
        }
    } else { // Display condensed pagination for more than 7 pages
        const startPages = [1, 2, 3];
        const endPages = [totalPages - 2, totalPages - 1, totalPages];
        const middlePages = [currentPage - 1, currentPage, currentPage + 1];

        // Function to create a page button
        const createPageButton = (page, isEllipsis = false) => {
            const btn = document.createElement("button");
            btn.innerHTML = isEllipsis ? "..." : page;
            btn.disabled = isEllipsis;
            if (!isEllipsis) {
                btn.className = page === currentPage ? "active" : "";
                btn.onclick = () => {
                    currentPage = page;
                    renderTable();
                    renderPagination(totalRows);
                };
            }
            return btn;
        };

        // Add first pages
        for (const page of startPages) {
            if (page <= totalPages) {
                paginationContainer.appendChild(createPageButton(page));
            }
        }
        
        // Add ellipsis if current page is not near the start
        if (currentPage > 4) {
            paginationContainer.appendChild(createPageButton("...", true));
        }

        // Add middle pages (current page and its neighbors)
        if (currentPage > 3 && currentPage < totalPages - 2) {
            for (const page of middlePages) {
                if (page > 0 && page <= totalPages) {
                    paginationContainer.appendChild(createPageButton(page));
                }
            }
        }

        // Add ellipsis if current page is not near the end
        if (currentPage < totalPages - 3) {
            paginationContainer.appendChild(createPageButton("...", true));
        }

        // Add last pages
        for (const page of endPages) {
            if (page > 3) {
                paginationContainer.appendChild(createPageButton(page));
            }
        }
    }

    // Next Button
    const nextButton = document.createElement("button");
    nextButton.innerHTML = "Next »";
    nextButton.disabled = currentPage === totalPages;
    nextButton.onclick = () => {
        currentPage++;
        renderTable();
        renderPagination(totalRows); // Re-render pagination after page change
    };
    paginationContainer.appendChild(nextButton);
}

function updateRowsPerPage() {
rowsPerPage = parseInt(rowsPerPageSelect.value);
currentPage = 1;
renderTable();
}

function searchTable() {
const query = searchInput.value.toLowerCase().trim();
filteredRows = allRows.filter(row =>
    Array.from(row.cells).some(cell => cell.textContent.toLowerCase().includes(query))
);

currentPage = 1;
rowsPerPageSelect.style.display = query ? "none" : "block";
renderTable();
}

rowsPerPageSelect.addEventListener("change", updateRowsPerPage);
searchInput.addEventListener("input", searchTable);
renderTable();
});
</script>
</div>
<div class="sub row flex">
    <div class="ctrl left height0 width20">
        <span id="totalRecords" class="totalRecords green"></span>
    </div>
    <div class="ctrl right height0 width70">
        <p>
            Display Per Page:
        </p>
        <div class="selectBar" style="width: 70px;"> 
            <select id="rowsPerPage" onchange="updateRowsPerPage()" style="width: 100px">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="1000000000000">All</option>
            </select>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>
</div>
